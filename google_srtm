// ================================================================================
// C√ìDIGO OPTIMIZADO - PENDIENTES 30-45¬∞ SOBRE 2000m - REGI√ìN METROPOLITANA
// ================================================================================

print('üèîÔ∏è Iniciando an√°lisis de pendientes SOBRE 2000m para Regi√≥n Metropolitana de Chile');

// PASO 1: Definir √°rea de estudio
var rm_bounds = ee.Geometry.Rectangle([-71.5, -34.0, -70.0, -33.0]);
print('‚úì √Årea de estudio definida: Regi√≥n Metropolitana');

// PASO 2: Cargar y procesar DEM
var srtm = ee.Image('USGS/SRTMGL1_003');
var dem_rm = srtm.clip(rm_bounds);
print('‚úì DEM SRTM cargado');

// PASO 3: Calcular pendientes
var slope_degrees = ee.Terrain.slope(dem_rm);
print('‚úì Pendientes calculadas');

// PASO 4: Crear m√°scara de elevaci√≥n > 2000m
var elevation_mask = dem_rm.gte(2000);
print('‚úì M√°scara de elevaci√≥n > 2000m creada');

// PASO 5: Identificar pendientes 30-45¬∞ SOLO en elevaciones > 2000m
var target_slopes = slope_degrees.gte(30)
                    .and(slope_degrees.lte(45))
                    .and(elevation_mask); // ‚Üê NUEVA CONDICI√ìN: solo sobre 2000m

print('‚úì Pendientes 30-45¬∞ sobre 2000m identificadas');

// PASO 6: Crear m√°scara para visualizaci√≥n
var slope_mask = target_slopes.selfMask();

// PASO 7: Configurar mapa
Map.centerObject(rm_bounds, 9);

// PASO 8: Agregar capas
Map.addLayer(dem_rm, {
  min: 0, 
  max: 6000, 
  palette: ['0066CC', '66CCFF', '99FF99', 'FFFF66', 'FF9900', 'FF0000', 'FFFFFF']
}, 'Elevaci√≥n (m)', false);

// Mostrar zona de elevaci√≥n > 2000m en azul claro
Map.addLayer(elevation_mask.selfMask(), {
  palette: ['87CEEB']
}, 'üîµ Elevaci√≥n > 2000m', false);

Map.addLayer(slope_degrees, {
  min: 0,
  max: 60,
  palette: ['00FF00', 'FFFF00', 'FF9900', 'FF0000', '990099']
}, 'Todas las pendientes (¬∞)', false);

// CAPA PRINCIPAL: Pendientes 30-45¬∞ SOLO sobre 2000m en ROJO
Map.addLayer(slope_mask, {
  palette: ['FF0000']
}, 'üî¥ Pendientes 30-45¬∞ (>2000m)', true);

Map.addLayer(rm_bounds, {
  color: '0066FF',
  fillColor: '0066FF00'
}, 'L√≠mite Regi√≥n Metropolitana', true);

print('‚úì Todas las capas agregadas correctamente');

// PASO 9: Estad√≠sticas OPTIMIZADAS para elevaciones > 2000m
print('üìä Calculando estad√≠sticas detalladas para elevaciones > 2000m...');

// √Årea con pendientes objetivo sobre 2000m
var pixel_area = ee.Image.pixelArea().divide(1000000); // km¬≤
var area_30_45_over_2000 = target_slopes.multiply(pixel_area);

// √Årea total sobre 2000m (para calcular porcentajes)
var total_area_over_2000 = elevation_mask.multiply(pixel_area);

// Estad√≠sticas principales
var combined_stats = ee.Dictionary({
  'area_slopes': area_30_45_over_2000.reduceRegion({
    reducer: ee.Reducer.sum(),
    geometry: rm_bounds,
    scale: 30,
    maxPixels: 1e9
  }),
  'area_total_2000m': total_area_over_2000.reduceRegion({
    reducer: ee.Reducer.sum(),
    geometry: rm_bounds,
    scale: 30,
    maxPixels: 1e9
  }),
  'slopes_all': slope_degrees.reduceRegion({
    reducer: ee.Reducer.minMax().combine(ee.Reducer.mean(), '', true),
    geometry: rm_bounds,
    scale: 30,
    maxPixels: 1e9
  }),
  'slopes_over_2000': slope_degrees.updateMask(elevation_mask).reduceRegion({
    reducer: ee.Reducer.minMax().combine(ee.Reducer.mean(), '', true),
    geometry: rm_bounds,
    scale: 30,
    maxPixels: 1e9
  })
});

// Mostrar estad√≠sticas principales
combined_stats.evaluate(function(results) {
  var area_slopes = results.area_slopes || {};
  var area_total_2000 = results.area_total_2000 || {};
  var slope_result = results.slopes_all || {};
  var slope_2000_result = results.slopes_over_2000 || {};
  
  print('');
  print('üìà ESTAD√çSTICAS GENERALES:');
  print('  ‚Ä¢ Pendiente m√≠nima (toda la regi√≥n): ' + (slope_result.slope_min || 0).toFixed(1) + '¬∞');
  print('  ‚Ä¢ Pendiente m√°xima (toda la regi√≥n): ' + (slope_result.slope_max || 0).toFixed(1) + '¬∞');  
  print('  ‚Ä¢ Pendiente promedio (toda la regi√≥n): ' + (slope_result.slope_mean || 0).toFixed(1) + '¬∞');
  
  print('');
  print('‚õ∞Ô∏è ESTAD√çSTICAS SOBRE 2000m:');
  print('  ‚Ä¢ Pendiente promedio (>2000m): ' + (slope_2000_result.slope_mean || 0).toFixed(1) + '¬∞');
  print('  ‚Ä¢ √Årea total sobre 2000m: ' + (area_total_2000.area || 0).toFixed(2) + ' km¬≤');
  
  var target_area = area_slopes.area || 0;
  print('üî¥ √ÅREA CON PENDIENTES 30-45¬∞ SOBRE 2000m: ' + target_area.toFixed(2) + ' km¬≤');
  
  // Calcular porcentajes
  var total_2000_area = area_total_2000.area || 0;
  if (total_2000_area > 0) {
    var percentage_of_high_elevation = (target_area / total_2000_area) * 100;
    print('üìä % del √°rea sobre 2000m con pendientes 30-45¬∞: ' + percentage_of_high_elevation.toFixed(1) + '%');
  }
  
  // Porcentaje respecto a toda la regi√≥n
  rm_bounds.area().divide(1000000).evaluate(function(total_area_result) {
    if (total_area_result && target_area > 0) {
      var percentage_total = (target_area / total_area_result) * 100;
      print('üìä % de toda la Regi√≥n Metropolitana: ' + percentage_total.toFixed(2) + '%');
    }
  });
});

// PASO 10: An√°lisis por sectores ADAPTADO para elevaciones altas
print('');
print('üìç AN√ÅLISIS POR SECTORES (solo zonas monta√±osas >2000m):');

var mountain_sectors = [
  {name: 'Cordillera Las Condes', coords: [-70.4500, -33.3500]},
  {name: 'Cordillera Lo Barnechea', coords: [-70.4200, -33.3200]},
  {name: 'Valle Nevado', coords: [-70.2500, -33.3500]},
  {name: 'La Parva', coords: [-70.2800, -33.2800]},
  {name: 'Farellones', coords: [-70.3100, -33.3100]}
];

mountain_sectors.forEach(function(sector) {
  var point = ee.Geometry.Point(sector.coords);
  var buffer = point.buffer(2500); // 2.5 km
  
  // Calcular estad√≠sticas del sector solo para >2000m
  var sector_stats = ee.Dictionary({
    'area_slopes': target_slopes.multiply(pixel_area).reduceRegion({
      reducer: ee.Reducer.sum(),
      geometry: buffer,
      scale: 30,
      maxPixels: 1e6
    }),
    'area_total_2000': elevation_mask.multiply(pixel_area).reduceRegion({
      reducer: ee.Reducer.sum(),
      geometry: buffer,
      scale: 30,
      maxPixels: 1e6
    }),
    'slope_mean_2000': slope_degrees.updateMask(elevation_mask).reduceRegion({
      reducer: ee.Reducer.mean(),
      geometry: buffer,
      scale: 30,
      maxPixels: 1e6
    })
  });
  
  sector_stats.evaluate(function(results) {
    var slope_area = results.area_slopes || {};
    var total_area = results.area_total_2000 || {};
    var slope_data = results.slope_mean_2000 || {};
    
    var area_val = slope_area.area || 0;
    var total_val = total_area.area || 0;
    var slope_val = slope_data.slope || 0;
    
    print('  ' + sector.name + ':');
    print('    - √Årea >2000m: ' + total_val.toFixed(2) + ' km¬≤');
    print('    - √Årea 30-45¬∞ (>2000m): ' + area_val.toFixed(2) + ' km¬≤');
    print('    - Pendiente promedio (>2000m): ' + slope_val.toFixed(1) + '¬∞');
  });
  
  // Agregar punto al mapa
  Map.addLayer(point, {color: 'FFFF00'}, sector.name, false);
});

// PASO 11: Funci√≥n de exportaci√≥n actualizada
function exportResults() {
  Export.image.toDrive({
    image: slope_mask,
    description: 'Pendientes_30_45_over_2000m_RM',
    folder: 'GEE_Chile_Analysis',
    region: rm_bounds,
    scale: 30,
    crs: 'EPSG:4326',
    maxPixels: 1e9
  });
  
  print('üìÅ Exportaci√≥n iniciada - Revisa pesta√±a "Tasks"');
}

// DESCOMENTA PARA EXPORTAR:
// exportResults();

// INFORMACI√ìN FINAL
print('');
print('üéØ ¬°AN√ÅLISIS COMPLETADO PARA ELEVACIONES >2000m!');
print('');
print('üîç LO QUE VES EN EL MAPA:');
print('  ‚Ä¢ √ÅREAS ROJAS = Pendientes 30-45¬∞ √öNICAMENTE sobre 2000m');
print('  ‚Ä¢ √ÅREAS AZULES = Todas las zonas sobre 2000m (si activadas)');
print('  ‚Ä¢ Concentraci√≥n en alta cordillera y centros de esqu√≠');
print('  ‚Ä¢ Zonas urbanas y valles NO aparecen (est√°n bajo 2000m)');
print('');
print('üìä DATOS T√âCNICOS:');
print('  ‚Ä¢ Resoluci√≥n: 30 metros por pixel');
print('  ‚Ä¢ Fuente: SRTM NASA');
print('  ‚Ä¢ Filtro: Elevaci√≥n > 2000 metros sobre nivel del mar');
print('  ‚Ä¢ M√©todo: An√°lise de gradientes topogr√°ficos filtrado');
print('');
print('‚úÖ Sistema funcionando sin errores');

// Agregar leyenda actualizada
var legend = ui.Panel({
  style: {
    position: 'bottom-left',
    padding: '8px 15px',
    backgroundColor: 'white'
  }
});

legend.add(ui.Label({
  value: 'üî¥ Pendientes 30-45¬∞ (>2000m)',
  style: {fontWeight: 'bold', fontSize: '16px'}
}));

legend.add(ui.Label({
  value: 'Terrenos con pendiente pronunciada\nSOLO en elevaciones superiores\na 2000 metros',
  style: {fontSize: '12px'}
}));

legend.add(ui.Label({
  value: 'üîµ Elevaci√≥n > 2000m (opcional)',
  style: {fontSize: '12px', color: '666'}
}));

Map.add(legend);

// Agregar panel de informaci√≥n actualizado
var infoPanel = ui.Panel({
  style: {
    position: 'top-right',
    padding: '10px',
    backgroundColor: 'white'
  }
});

infoPanel.add(ui.Label({
  value: 'üìä AN√ÅLISIS ALTA MONTA√ëA',
  style: {fontWeight: 'bold'}
}));

infoPanel.add(ui.Label({
  value: 'Filtro: Elevaci√≥n > 2000m\nPendientes: 30-45 grados\nZona: Alta Cordillera\nCentros de esqu√≠ incluidos',
  style: {fontSize: '11px'}
}));

Map.add(infoPanel);
